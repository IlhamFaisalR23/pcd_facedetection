<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deteksi Ras</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- Step 1: Name Section -->
        <div id="namaSection" class="section active">
            <div class="welcome-card">
                <h1>Halo!</h1>
                <p class="welcome-text">Boleh kenalan dulu dong, siapa nama kamu?</p>
                <div class="input-group">
                    <input type="text" id="namaInput" placeholder="Ketik nama kamu di sini..." autocomplete="off">
                    <button class="button" id="lanjutButton">Lanjut</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Options Section -->
        <div id="optionsSection" class="section">
            <h1>Hai, <span id="namaDisplay">Kawan</span>!</h1>
            <p class="subtitle">Mau pilih yang mana nih?</p>
            <div class="options-container">
                <div class="option-card" id="uploadOption">
                    <div class="option-icon">üìÅ</div>
                    <h2>Unggah Gambar</h2>
                    <p>Pilih atau tarik file gambar dari perangkatmu</p>
                </div>
                <div class="option-card" id="cameraOption">
                    <div class="option-icon">üì∑</div>
                    <h2>Gunakan Kamera</h2>
                    <p>Ambil foto menggunakan kamera depan</p>
                </div>
            </div>
        </div>

        <!-- Step 3a: Upload Section -->
        <div id="uploadSection" class="section">
            <button class="back-button" id="backFromUpload">‚Üê Kembali</button>
            <h1>Unggah Gambar</h1>
            <div class="feature-container">
                <div class="upload-area" id="drop-area">
                    <div class="icon">üìÅ</div>
                    <p>Seret file gambar ke sini atau klik untuk memilih</p>
                    <input type="file" id="fileUpload" accept="image/*">
                </div>
                <div class="error-message" id="uploadErrorMessage" style="display: none;"></div>
                <div class="buttons-row">
                    <button class="button" id="chooseFileBtn">Pilih File</button>
                    <button class="button button-secondary" id="processUploadBtn" disabled>Proses Gambar</button>
                    <button class="button button-secondary" id="viewUploadResultBtn" disabled>Lihat Hasil</button>
                </div>
            </div>
        </div>

        <!-- Step 3b: Camera Section -->
        <div id="cameraSection" class="section">
            <button class="back-button" id="backFromCamera">‚Üê Kembali</button>
            <h1>Kamera</h1>
            <div class="feature-container">
                <div class="camera-placeholder" id="cameraPlaceholder">
                    <div id="webcamContainer" class="mt-3">
                        <img id="webcamFeed" class="camera-placeholder" style="display: none;">
                        <div id="webcamPlaceholder" class="camera-placeholder-text">
                            <div class="icon">üì∑</div>
                            <p>Klik tombol "Mulai Kamera" untuk mengakses kamera</p>
                        </div>
                    </div>
                    <canvas id="canvasElement" style="display: none;"></canvas>
                </div>
                <div class="error-message" id="cameraErrorMessage" style="display: none;"></div>
                <div class="camera-controls">
                    <button class="button" id="startWebcam">Mulai Kamera</button>
                    <button class="capture-button" id="captureBtn" style="display: none;">Ambil Foto</button>
                    <button class="button button-secondary" id="viewCameraResultBtn" style="display: none;">Lihat Hasil</button>
                </div>
            </div>
        </div>

        <!-- Step 4: Result Section -->
        <div id="resultSection" class="section">
            <button class="back-button" id="backFromResult">‚Üê Kembali</button>
            <h1>Hasil</h1>
            <div class="result-card">
                <div class="result-content">
                    <div class="face-crop-container" id="faceCropContainer">
                        <img id="faceCropImage" alt="Crop wajah">
                        <div class="user-info">
                            <p><strong>Nama:</strong> <span id="resultNama"></span></p>
                            <p><strong>Ras:</strong> <span id="resultRas">Tidak Diketahui</span></p>
                        </div>
                    </div>
                    
                    <div class="error-message" id="resultErrorMessage"></div>
                    
                    <div class="buttons-row">
                        <button class="button" id="downloadCropBtn">Unduh Gambar</button>
                        <button class="button button-secondary" id="newSessionBtn">Sesi Baru</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Generate unique user ID
        function generateUserId() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // Store user data and results
        const userData = {
            name: '',
            id: '',
            imageData: null,
            faceCropData: null,
            race: 'Tidak Diketahui'
        };

        // Navigation between sections
        const namaSection = document.getElementById('namaSection');
        const optionsSection = document.getElementById('optionsSection');
        const uploadSection = document.getElementById('uploadSection');
        const cameraSection = document.getElementById('cameraSection');
        const resultSection = document.getElementById('resultSection');
        
        const namaInput = document.getElementById('namaInput');
        const lanjutButton = document.getElementById('lanjutButton');
        const namaDisplay = document.getElementById('namaDisplay');
        
        const uploadOption = document.getElementById('uploadOption');
        const cameraOption = document.getElementById('cameraOption');
        
        const backFromUpload = document.getElementById('backFromUpload');
        const backFromCamera = document.getElementById('backFromCamera');
        const backFromResult = document.getElementById('backFromResult');

        const processUploadBtn = document.getElementById('processUploadBtn');
        const viewUploadResultBtn = document.getElementById('viewUploadResultBtn');
        const viewCameraResultBtn = document.getElementById('viewCameraResultBtn');

        const faceCropContainer = document.getElementById('faceCropContainer');
        const faceCropImage = document.getElementById('faceCropImage');
        const resultNama = document.getElementById('resultNama');
        const resultRas = document.getElementById('resultRas');

        const downloadCropBtn = document.getElementById('downloadCropBtn');
        const newSessionBtn = document.getElementById('newSessionBtn');

        // Error message elements
        const uploadErrorMessage = document.getElementById('uploadErrorMessage');
        const cameraErrorMessage = document.getElementById('cameraErrorMessage');
        const resultErrorMessage = document.getElementById('resultErrorMessage');

        // Step 1 to Step 2 - Enter name and proceed
        lanjutButton.addEventListener('click', () => {
            const nama = namaInput.value.trim();
            if (nama) {
                // Generate and store user data
                userData.name = nama;
                userData.id = generateUserId();
                
                // Update display
                namaDisplay.textContent = nama;
                
                switchSection(namaSection, optionsSection);
            } else {
                namaInput.classList.add('error');
                setTimeout(() => namaInput.classList.remove('error'), 500);
            }
        });

        // Enter key functionality
        namaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                lanjutButton.click();
            }
        });

        // Step 2 to Step 3a - Choose Upload
        uploadOption.addEventListener('click', () => {
            userData.method = 'Upload';
            switchSection(optionsSection, uploadSection);
        });

        // Step 2 to Step 3b - Choose Camera
        cameraOption.addEventListener('click', () => {
            userData.method = 'Kamera';
            switchSection(optionsSection, cameraSection);
        });

        // Back buttons
        backFromUpload.addEventListener('click', () => {
            switchSection(uploadSection, optionsSection);
        });

        backFromCamera.addEventListener('click', () => {
            switchSection(cameraSection, optionsSection);
        });

        backFromResult.addEventListener('click', () => {
            if (userData.method === 'Upload') {
                switchSection(resultSection, uploadSection);
            } else if (userData.method === 'Kamera') {
                switchSection(resultSection, cameraSection);
            }
        });

        // Process uploaded image
        processUploadBtn.addEventListener('click', async () => {
            if (!userData.tempImageData) {
                uploadErrorMessage.textContent = 'Tidak ada gambar untuk diproses';
                uploadErrorMessage.style.display = 'block';
                return;
            }

            processUploadBtn.disabled = true;
            processUploadBtn.textContent = 'Memproses...';

            try {
                // Create a form data object
                const formData = new FormData();
                
                // Convert base64 to blob
                const response = await fetch(userData.tempImageData);
                const blob = await response.blob();
                formData.append('file', blob, 'image.jpg');
                
                // Send the image to the server for processing
                const result = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await result.json();
                
                if (data.status === 'success') {
                    // Store the processed image data
                    userData.faceCropData = data.face_crop;
                    userData.race = data.race || 'Tidak Diketahui';
                    
                    // Enable the view result button
                    viewUploadResultBtn.disabled = false;
                    uploadErrorMessage.style.display = 'none';
                } else {
                    // Display error message
                    uploadErrorMessage.textContent = data.message || 'Terjadi kesalahan saat memproses gambar';
                    uploadErrorMessage.style.display = 'block';
                    
                    // Still store the result image if available
                    if (data.result_image) {
                        userData.imageData = data.result_image;
                        viewUploadResultBtn.disabled = false;
                    }
                }
            } catch (error) {
                console.error('Error processing image:', error);
                uploadErrorMessage.textContent = 'Terjadi kesalahan saat memproses gambar';
                uploadErrorMessage.style.display = 'block';
            } finally {
                processUploadBtn.disabled = false;
                processUploadBtn.textContent = 'Proses Gambar';
            }
        });

        // View Results buttons
        viewUploadResultBtn.addEventListener('click', () => {
            displayResults();
            switchSection(uploadSection, resultSection);
        });

        viewCameraResultBtn.addEventListener('click', () => {
            displayResults();
            switchSection(cameraSection, resultSection);
        });

        // New session button
        newSessionBtn.addEventListener('click', () => {
            // Reset everything and start over
            namaInput.value = '';
            userData.name = '';
            userData.id = '';
            userData.method = '';
            userData.imageData = null;
            userData.faceCropData = null;
            userData.race = 'Tidak Diketahui';
            userData.tempImageData = null;
            
            // Reset UI elements
            faceCropContainer.style.display = 'none';
            downloadCropBtn.style.display = 'none';
            uploadErrorMessage.style.display = 'none';
            cameraErrorMessage.style.display = 'none';
            resultErrorMessage.style.display = 'none';
            
            // Reset webcam if active
            if (window.stream) {
                window.stream.getTracks().forEach(track => track.stop());
                window.stream = null;
            }
            
            // Reset webcam UI
            document.getElementById('webcamFeed').style.display = 'none';
            document.getElementById('webcamPlaceholder').style.display = 'block';
            document.getElementById('startWebcam').textContent = 'Mulai Kamera';
            document.getElementById('captureBtn').style.display = 'none';
            viewCameraResultBtn.style.display = 'none';
            
            // Reset upload area
            resetUploadArea();
            
            // Navigate back to start
            switchSection(resultSection, namaSection);
        });

        // Download buttons
        downloadCropBtn.addEventListener('click', () => {
            if (userData.faceCropData) {
                const link = document.createElement('a');
                link.href = userData.faceCropData;
                link.download = `${userData.name}_crop_${userData.id}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        function switchSection(fromSection, toSection) {
            fromSection.classList.remove('active');
            fromSection.classList.add('fade-out');
            
            setTimeout(() => {
                fromSection.classList.remove('fade-out');
                fromSection.style.display = 'none';
                
                toSection.style.display = 'block';
                setTimeout(() => {
                    toSection.classList.add('active');
                }, 50);
            }, 300);
        }

        function displayResults() {
            resultNama.textContent = userData.name;
            resultRas.textContent = userData.race;
            
            if (userData.faceCropData) {
                faceCropImage.src = userData.faceCropData;
                faceCropContainer.style.display = 'flex';
                downloadCropBtn.style.display = 'inline-block';
            } else {
                faceCropContainer.style.display = 'none';
                downloadCropBtn.style.display = 'none';
                
                if (userData.imageData) {
                    resultErrorMessage.textContent = 'Tidak ada wajah terdeteksi dalam gambar';
                    resultErrorMessage.style.display = 'block';
                }
            }
        }

        // File upload handling
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('fileUpload');
        const chooseFileBtn = document.getElementById('chooseFileBtn');

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        // Highlight drop area when a file is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        // Handle dropped files
        dropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);
        chooseFileBtn.addEventListener('click', () => fileInput.click());

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            dropArea.classList.add('highlight');
        }

        function unhighlight() {
            dropArea.classList.remove('highlight');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({target: {files}});
        }

        function resetUploadArea() {
            dropArea.innerHTML = `<div class="icon">üìÅ</div><p>Seret file gambar ke sini atau klik untuk memilih</p>`;
            const newFileInput = document.createElement('input');
            newFileInput.type = 'file';
            newFileInput.id = 'fileUpload';
            newFileInput.accept = 'image/*';
            newFileInput.addEventListener('change', handleFiles, false);
            dropArea.appendChild(newFileInput);
            
            processUploadBtn.disabled = true;
            viewUploadResultBtn.disabled = true;
        }

        function handleFiles(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    // Read the file and set as temporary image data
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        userData.tempImageData = event.target.result;
                        dropArea.innerHTML = `<div class="icon">‚úÖ</div><p>File dipilih: ${file.name}</p><img src="${event.target.result}" alt="Preview" class="preview-image">`;
                        processUploadBtn.disabled = false;
                        viewUploadResultBtn.disabled = true; // Disable until processed
                        uploadErrorMessage.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else {
                    dropArea.innerHTML = `<div class="icon">‚ùå</div><p>File harus berupa gambar</p>`;
                    processUploadBtn.disabled = true;
                    viewUploadResultBtn.disabled = true;
                    uploadErrorMessage.textContent = 'File harus berupa gambar';
                    uploadErrorMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        resetUploadArea();
                    }, 2000);
                }
            }
        }

        // Handle webcam
        document.getElementById('startWebcam').addEventListener('click', () => {
            const webcamContainer = document.getElementById('webcamContainer');
            const webcamFeed = document.getElementById('webcamFeed');
            const button = document.getElementById('startWebcam');
            
            if (webcamContainer.classList.contains('d-none')) {
                webcamFeed.src = '/webcam';
                webcamContainer.classList.remove('d-none');
                button.textContent = 'Stop Webcam';
                button.classList.remove('btn-primary');
                button.classList.add('btn-danger');
            } else {
                webcamFeed.src = '';
                webcamContainer.classList.add('d-none');
                button.textContent = 'Start Webcam';
                button.classList.remove('btn-danger');
                button.classList.add('btn-primary');
            }
        });
    </script>
</body>
</html>